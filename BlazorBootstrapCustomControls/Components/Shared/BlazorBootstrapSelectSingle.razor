@* Bootstrap-based single-select component. See README.md for the specification. *@
@using System.Collections.Generic
@typeparam TItem
@typeparam TValue
@inherits BlazorBootstrapSelectBase<TItem, TValue>

<BlazorBootstrapSelectMarkup TValue="TValue" Id="@_id"
                       Label="@Label"
                       Width="@Width"
                       AutoExpandVertically="@AutoExpandVertically"
                       Disabled="@Disabled"
                       Open="@_open"
                       DisplayText="@DisplayText"
                       IsPlaceholder="@IsPlaceholder"
                       ShowClearButton="@ShowClearButton"
                       ShouldShowClearButton="@ShouldShowClearButton"
                       IsMulti="false"
                       Items="@_items"
                       HighlightedIndex="@_highlightedIndex"
                       IsItemSelected="@IsItemSelected"
                       OnInputClick="@OnInputClick"
                       OnInputBlur="@OnInputBlur"
                       OnClear="@OnClear"
                       SelectItem="@SelectItem"
                       OnItemHover="@OnItemHover"
                       OnItemMouseDown="@OnItemMouseDown" />

@if (ValidationMessage != null)
{
  <ValidationMessage For="@ValidationMessage" />
}

@code {
  /// <summary>
  /// Gets or sets the selected value. Use @bind-Value for two-way data binding.
  /// </summary>
  [Parameter] public TValue? Value { get; set; }

  /// <summary>
  /// Gets or sets the callback that is invoked when the selected value changes.
  /// </summary>
  [Parameter] public EventCallback<TValue?> ValueChanged { get; set; }

  /// <summary>
  /// Gets or sets a value indicating whether clicking a selected item will deselect it.
  /// When true, users can click the selected item again to clear the selection.
  /// Defaults to true.
  /// </summary>
  [Parameter] public bool AllowDeselect { get; set; } = true;

  /// <summary>
  /// Gets or sets the expression identifying the value to validate.
  /// Used with EditForm and ValidationMessage components for form validation.
  /// </summary>
  [Parameter] public Expression<Func<TValue?>>? ValidationMessage { get; set; }

  protected override string DisplayText => IsPlaceholder
    ? (PlaceholderText ?? "")
    : (_items.FirstOrDefault(i => EqualityComparer<TValue>.Default.Equals(i.Value, Value)).Text
       ?? Value?.ToString()
       ?? "");

  protected override bool IsPlaceholder => Value is null;

  protected override bool ShouldShowClearButton => AllowDeselect && Value is not null;

  protected override bool IsItemSelected(TValue value) =>
    Value is not null && EqualityComparer<TValue>.Default.Equals(value, Value);

  protected override async Task OnClearValue()
  {
    await ValueChanged.InvokeAsync(default);
  }

  protected override async Task OnSelectItem(TValue value)
  {
    if (Value is not null && EqualityComparer<TValue>.Default.Equals(value, Value))
    {
      if (AllowDeselect)
      {
        await ValueChanged.InvokeAsync(default);
        await Close(focusInput: true);
      }
    }
    else
    {
      await ValueChanged.InvokeAsync(value);
      await Close(focusInput: true);
    }
  }

  protected override async Task OnHandleEnterKey(int highlightedIndex)
  {
    var item = _items[highlightedIndex];
    if (Value is not null && EqualityComparer<TValue>.Default.Equals(item.Value, Value))
    {
      if (AllowDeselect)
      {
        await ValueChanged.InvokeAsync(default);
        await Close(focusInput: true);
      }
    }
    else
    {
      await ValueChanged.InvokeAsync(item.Value);
      await Close(focusInput: true);
    }
  }
}
