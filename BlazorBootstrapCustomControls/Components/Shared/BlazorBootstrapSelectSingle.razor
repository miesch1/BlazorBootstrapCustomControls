@* Bootstrap-based single-select component. See README.md for the specification. *@
@typeparam TItem
@inherits BlazorBootstrapSelectBase<TItem>

<BlazorBootstrapSelectMarkup Id="@_id"
                       Label="@Label"
                       Width="@Width"
                       AutoExpandVertically="@AutoExpandVertically"
                       Disabled="@Disabled"
                       Open="@_open"
                       DisplayText="@DisplayText"
                       IsPlaceholder="@IsPlaceholder"
                       ShowClearButton="@ShowClearButton"
                       ShouldShowClearButton="@ShouldShowClearButton"
                       IsMulti="false"
                       Items="@_items"
                       HighlightedIndex="@_highlightedIndex"
                       IsItemSelected="@IsItemSelected"
                       OnInputClick="@OnInputClick"
                       OnInputBlur="@OnInputBlur"
                       OnClear="@OnClear"
                       SelectItem="@SelectItem"
                       OnItemHover="@OnItemHover"
                       OnItemMouseDown="@OnItemMouseDown" />

@if (ValidationMessage != null)
{
  <ValidationMessage For="@ValidationMessage" />
}

@code {
  /// <summary>
  /// Gets or sets the selected value. Use @bind-Value for two-way data binding.
  /// </summary>
  [Parameter] public string? Value { get; set; }

  /// <summary>
  /// Gets or sets the callback that is invoked when the selected value changes.
  /// </summary>
  [Parameter] public EventCallback<string?> ValueChanged { get; set; }

  /// <summary>
  /// Gets or sets a value indicating whether clicking a selected item will deselect it.
  /// When true, users can click the selected item again to clear the selection.
  /// Defaults to true.
  /// </summary>
  [Parameter] public bool AllowDeselect { get; set; } = true;

  /// <summary>
  /// Gets or sets the expression identifying the value to validate.
  /// Used with EditForm and ValidationMessage components for form validation.
  /// </summary>
  [Parameter] public Expression<Func<string?>>? ValidationMessage { get; set; }

  protected override string DisplayText => IsPlaceholder
    ? (PlaceholderText ?? "")
    : (_items.FirstOrDefault(i => i.Value == Value).Text ?? Value ?? "");

  protected override bool IsPlaceholder => string.IsNullOrEmpty(Value);

  protected override bool ShouldShowClearButton => AllowDeselect && !string.IsNullOrEmpty(Value);

  protected override bool IsItemSelected(string value) => value == Value;

  protected override async Task OnClearValue()
  {
    await ValueChanged.InvokeAsync(null);
  }

  protected override async Task OnSelectItem(string value)
  {
    if (value == Value)
    {
      if (AllowDeselect)
      {
        await ValueChanged.InvokeAsync(null);
        await Close(focusInput: true);
      }
    }
    else
    {
      await ValueChanged.InvokeAsync(value);
      await Close(focusInput: true);
    }
  }

  protected override async Task OnHandleEnterKey(int highlightedIndex)
  {
    var item = _items[highlightedIndex];
    if (item.Value == Value)
    {
      if (AllowDeselect)
      {
        await ValueChanged.InvokeAsync(null);
        await Close(focusInput: true);
      }
    }
    else
    {
      await ValueChanged.InvokeAsync(item.Value);
      await Close(focusInput: true);
    }
  }
}
